
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pyzernike.xy_zernike_polynomial &#8212; pyzernike 2.1.2 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=b3e23499"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/pyzernike/xy_zernike_polynomial';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">pyzernike 2.1.2 documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../installation.html">
    Installation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../mathematical_description.html">
    Mathematical description
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../usage.html">
    Usage
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../installation.html">
    Installation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../mathematical_description.html">
    Mathematical description
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../usage.html">
    Usage
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">pyzernike.xy_zernike_polynomial</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for pyzernike.xy_zernike_polynomial</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2025 Artezaru</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numbers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Integral</span><span class="p">,</span> <span class="n">Real</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.core.core_polynomial</span><span class="w"> </span><span class="kn">import</span> <span class="n">core_polynomial</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.core.core_cartesian_to_elliptic_annulus</span><span class="w"> </span><span class="kn">import</span> <span class="n">core_cartesian_to_elliptic_annulus</span>

<div class="viewcode-block" id="xy_zernike_polynomial">
<a class="viewcode-back" href="../../api_doc/xy_zernike_polynomial.html#pyzernike.xy_zernike_polynomial">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">xy_zernike_polynomial</span><span class="p">(</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">n</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Integral</span><span class="p">],</span>
    <span class="n">m</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Integral</span><span class="p">],</span>
    <span class="n">Rx</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> 
    <span class="n">Ry</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> 
    <span class="n">x0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> 
    <span class="n">y0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> 
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> 
    <span class="n">h</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> 
    <span class="n">x_derivative</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Integral</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">y_derivative</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Integral</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">default</span><span class="p">:</span> <span class="n">Real</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
    <span class="n">precompute</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">_skip</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the Zernike polynomial :math:`Z_{n}^{m}(\rho_{eq}, \theta_{eq})` for given cartesian coordinates :math:`(x, y)` on an elliptic annulus domain.</span>

<span class="sd">    .. seealso::</span>

<span class="sd">        - :func:`pyzernike.zernike_polynomial` for computing the Zernike polynomial :math:`Z_{n}^{m}` for polar coordinates :math:`(\rho, \theta)`. </span>
<span class="sd">        - :func:`pyzernike.cartesian_to_elliptic_annulus` to convert Cartesian coordinates to elliptic annulus domain polar coordinates.</span>
<span class="sd">        - The page :doc:`../../mathematical_description` in the documentation for the mathematical extension of the Zernike polynomials on the elliptic domain.</span>

<span class="sd">    .. seealso::</span>

<span class="sd">        For the mathematical development of the method, see the paper `Generalization of Zernike polynomials for regular portions of circles and ellipses` by Rafael Navarro, José L. López, José Rx. Díaz, and Ester Pérez Sinusía.</span>
<span class="sd">        The associated paper is available in the resources folder of the package.</span>

<span class="sd">        Download the PDF : :download:`PDF &lt;../../../pyzernike/resources/Navarro and al. Generalization of Zernike polynomials for regular portions of circles and ellipses.pdf&gt;`</span>

<span class="sd">    Lets consider the extended elliptic annulus domain defined by the following parameters:</span>

<span class="sd">    .. figure:: ../../../pyzernike/resources/elliptic_annulus_domain.png</span>
<span class="sd">        :width: 400px</span>
<span class="sd">        :align: center</span>

<span class="sd">        The parameters to define the extended domain of the Zernike polynomial.</span>

<span class="sd">    The parameters are:</span>

<span class="sd">    - :math:`R_x` and :math:`R_y` are the lengths of the semi-axis of the ellipse.</span>
<span class="sd">    - :math:`x_0` and :math:`y_0` are the coordinates of the center of the ellipse.</span>
<span class="sd">    - :math:`\alpha` is the rotation angle of the ellipse in radians.</span>
<span class="sd">    - :math:`h=\frac{a}{R_x}=\frac{b}{R_y}` defining the inner boundary of the ellipse.</span>

<span class="sd">    The Zernike polynomial :math:`Z_{n}^{m}(\rho_{eq}, \theta_{eq})` is computed for the equivalent polar coordinates.</span>
<span class="sd">    </span>
<span class="sd">    This function allows to compute several Zernike polynomials at once for different sets of (order, degree, derivative orders) given as sequences,</span>
<span class="sd">    which can be more efficient than calling the polynomial function multiple times.</span>

<span class="sd">    - The parameters ``x`` and ``y`` must be numpy arrays of the same shape.</span>
<span class="sd">    - The parameters ``n``, ``m``, ``x_derivative`` and ``y_derivative`` must be sequences of integers with the same length.</span>

<span class="sd">    The output is a list of numpy arrays, each containing the values of the Zernike polynomial for the corresponding order and degree.</span>
<span class="sd">    The list has the same length as the input sequences and the arrays have the same shape as ``x``.</span>

<span class="sd">    .. note::</span>

<span class="sd">        If the input ``x`` or ``y`` are not floating point numpy arrays, it is converted to one with ``numpy.float64`` dtype.</span>
<span class="sd">        If the input ``x`` or ``y`` are floating point numpy arrays (ex: ``numpy.float32``), the computation will be done in ``numpy.float32``.</span>
<span class="sd">        If the input ``x`` and ``y`` are not of the same dtype, they are both converted to ``numpy.float64``.</span>

<span class="sd">    .. warning::</span>

<span class="sd">        The only available derivatives are the first and second order derivatives with respect to x or y independently (jacobian and hessian matrix).</span>
<span class="sd">        For more complex derivatives, please implement the Faa di Bruno&#39;s formula using the standard Zernike polynomial function with polar coordinates.</span>

<span class="sd">        - Available derivatives (:math:(dx, dy)): (0, 0), (1, 0), (0, 1), (2, 0), (0, 2), (1, 1).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : Sequence[float]</span>
<span class="sd">        The x coordinates in Cartesian system with shape (...,).</span>

<span class="sd">    y : Sequence[float]</span>
<span class="sd">        The y coordinates in Cartesian system with shape (...,).</span>

<span class="sd">    n : Sequence[Integral]</span>
<span class="sd">        A list of the radial order(s) of the Zernike polynomial(s) to compute.</span>

<span class="sd">    m : Sequence[Integral]</span>
<span class="sd">        A list of the radial degree(s) of the Zernike polynomial(s) to compute.</span>

<span class="sd">    Rx : float, optional</span>
<span class="sd">        The length of the semi-axis of the ellipse along x axis. Must be strictly positive.</span>
<span class="sd">        The default is 1.0, which corresponds to the unit circle.</span>

<span class="sd">    Ry : float, optional</span>
<span class="sd">        The length of the semi-axis of the ellipse along y axis. Must be strictly positive.</span>
<span class="sd">        The default is 1.0, which corresponds to the unit circle.</span>

<span class="sd">    x0 : float, optional</span>
<span class="sd">        The x coordinate of the center of the ellipse. Can be any real number.</span>
<span class="sd">        The default is 0.0, which corresponds to an ellipse centered at the origin.</span>

<span class="sd">    y0 : float, optional</span>
<span class="sd">        The y coordinate of the center of the ellipse. Can be any real number.</span>
<span class="sd">        The default is 0.0, which corresponds to an ellipse centered at the origin.</span>

<span class="sd">    alpha : float, optional</span>
<span class="sd">        The rotation angle of the ellipse in radians. Can be any real number.</span>
<span class="sd">        The default is 0.0, such as :math:`x` and :math:`y` axis are aligned with the ellipse axes.</span>

<span class="sd">    h : float, optional</span>
<span class="sd">        The ratio of the inner semi-axis to the outer semi-axis. Must be in the range [0, 1).</span>
<span class="sd">        The default is 0.0, which corresponds to a filled ellipse.</span>

<span class="sd">    x_derivative : Sequence[Integral], optional</span>
<span class="sd">        The derivative order with respect to x to compute. Must be a sequence of non-negative integers of the same length as `n` and `m`.</span>
<span class="sd">        The default is None, which corresponds to the 0th derivative (the polynomial itself).</span>

<span class="sd">    y_derivative : Sequence[Integral], optional</span>
<span class="sd">        The derivative order with respect to y to compute. Must be a sequence of non-negative integers of the same length as `n` and `m`.</span>
<span class="sd">        The default is None, which corresponds to the 0th derivative (the polynomial itself).</span>

<span class="sd">    default : Real, optional</span>
<span class="sd">        The default value to use for points outside the elliptic annulus domain. Must be a real number.</span>
<span class="sd">        The default is numpy.nan.</span>

<span class="sd">    precompute : bool, optional</span>
<span class="sd">        If True, precomputes the useful terms for better performance when computing multiple polynomials with the same rho values.</span>
<span class="sd">        If False, computes the useful terms on the fly for each polynomial to avoid memory overhead.</span>
<span class="sd">        The default is True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List[numpy.ndarray]</span>
<span class="sd">        A list of numpy arrays containing the Zernike polynomial values for each order and degree.</span>
<span class="sd">        Each array has the same shape as ``x``.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    TypeError</span>
<span class="sd">        If the x or y values can not be converted to a numpy array of floating points values.</span>
<span class="sd">        If n, m, x_derivative or y_derivative (if not None) are not sequences of integers.</span>

<span class="sd">    ValueError</span>
<span class="sd">        If the x and y do not have the same shape.</span>
<span class="sd">        If the lengths of n, m, x_derivative and y_derivative (if not None) are not the same.</span>
<span class="sd">        If Rx or Ry are not strictly positive.</span>
<span class="sd">        If h is not in the range [0, 1[.</span>
<span class="sd">        If the derivative orders are higher than 2 or mixed (ex: (1, 1)).</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Let&#39;s consider a full circle with a radius of 10 centered at the origin (1, 1).</span>
<span class="sd">    The value of the zernike polynomial :math:`Z_{2}^{0}` at the point (x, y) is given by:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        import numpy</span>
<span class="sd">        from pyzernike import xy_zernike_polynomial # or Zxy</span>
<span class="sd">        x = numpy.linspace(-10, 10, 100)</span>
<span class="sd">        y = numpy.linspace(-10, 10, 100)</span>
<span class="sd">        X, Y = numpy.meshgrid(x, y)</span>

<span class="sd">        output = xy_zernike_polynomial(X, Y, n=[2], m=[0], Rx=10, Ry=10, x0=1.0, y0=1.0) # List with a single numpy array</span>
<span class="sd">        zernike_n2_m0 = output[0] # Shape similar to X and Y</span>

<span class="sd">    returns a list with a single numpy array containing the values of the Zernike polynomial :math:`Z_{2}^{0}` at the points (X, Y) within the circle of radius 10.</span>

<span class="sd">    To compute the first derivative with respect to x and y, we can use:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        output = xy_zernike_polynomial(X, Y, n=[2, 2], m=[0, 0], Rx=10, Ry=10, x0=1.0, y0=1.0, x_derivative=[1, 0], y_derivative=[0, 1]) # List with two numpy arrays</span>
<span class="sd">        zernike_n2_m0_dx = output[0] # First derivative with respect to x</span>
<span class="sd">        zernike_n2_m0_dy = output[1] # First derivative with respect to y</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_skip</span><span class="p">:</span>
        <span class="c1"># Convert x and y to numpy arrays of floating point values</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="c1"># Convert x and y in arrays of floating point values if they are not already</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="c1"># If x and y are not of the same dtype, convert them to float64</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">y</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">Integral</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;n must be a sequence of integers.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">Integral</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;m must be a sequence of integers.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x_derivative</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_derivative</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">Integral</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x_derivative</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;x_derivative must be a sequence of non-negative integers.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">y_derivative</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y_derivative</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">Integral</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">y_derivative</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;y_derivative must be a sequence of non-negative integers.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Real</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Default value must be a real number.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">precompute</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;precompute must be a boolean.&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;x and y must have the same shape.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;n and m must have the same length.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x_derivative</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_derivative</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;n and x_derivative must have the same length.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">y_derivative</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_derivative</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;n and y_derivative must have the same length.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x_derivative</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_derivative</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">y_derivative</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y_derivative</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Rx</span><span class="p">,</span> <span class="n">Real</span><span class="p">)</span> <span class="ow">or</span> <span class="n">Rx</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Rx must be a positive real number.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Ry</span><span class="p">,</span> <span class="n">Real</span><span class="p">)</span> <span class="ow">or</span> <span class="n">Ry</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Ry must be a positive real number.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">Real</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;x0 must be a real number.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span> <span class="n">Real</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;y0 must be a real number.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Real</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Alpha must be a real number.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">Real</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;h must be a real number in the range [0, 1[.&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">x_derivative</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">y_derivative</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The function supports only the derivatives (0, 0), (1, 0), (0, 1), (2, 0), (0, 2), and (1, 1). For more complex derivatives, use the standard Zernike polynomial function with polar coordinates.&quot;</span><span class="p">)</span>

    <span class="c1"># Searching what is the derivatives to compute</span>
    <span class="n">total_derivative_orders</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_derivative</span><span class="p">)</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_derivative</span><span class="p">)</span>
    <span class="n">max_derivative_order</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">total_derivative_orders</span><span class="p">)</span>
    <span class="n">min_derivative_order</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">total_derivative_orders</span><span class="p">)</span>
    <span class="n">skip_0_derivative</span> <span class="o">=</span> <span class="n">min_derivative_order</span> <span class="o">&gt;=</span> <span class="mi">1</span>
    <span class="n">shift_0_derivative</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">skip_0_derivative</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="c1"># Compute rho_eq, theta_eq on the elliptic annulus domain and their derivatives if needed</span>
    <span class="k">if</span> <span class="n">max_derivative_order</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Only extract rho and theta</span>
        <span class="n">list_rho_eq</span><span class="p">,</span> <span class="n">list_theta_eq</span> <span class="o">=</span> <span class="n">core_cartesian_to_elliptic_annulus</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Rx</span><span class="p">,</span> <span class="n">Ry</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">x_derivative</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_derivative</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">max_derivative_order</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Extract rho, theta and their first derivatives</span>
        <span class="n">list_rho_eq</span><span class="p">,</span> <span class="n">list_theta_eq</span> <span class="o">=</span> <span class="n">core_cartesian_to_elliptic_annulus</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Rx</span><span class="p">,</span> <span class="n">Ry</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">x_derivative</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_derivative</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">max_derivative_order</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># Extract rho, theta and their first and second derivatives</span>
        <span class="n">list_rho_eq</span><span class="p">,</span> <span class="n">list_theta_eq</span> <span class="o">=</span> <span class="n">core_cartesian_to_elliptic_annulus</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Rx</span><span class="p">,</span> <span class="n">Ry</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">x_derivative</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y_derivative</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The function supports only the derivatives (0, 0), (1, 0), (0, 1), (2, 0), (0, 2), and (1, 1). For more complex derivatives, use the standard Zernike polynomial function with polar coordinates.&quot;</span><span class="p">)</span>

    <span class="n">rho</span> <span class="o">=</span> <span class="n">list_rho_eq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">list_theta_eq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Compute the Mask for valid rho values</span>
    <span class="n">domain_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">rho</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rho</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">finite_mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">domain_mask</span> <span class="o">&amp;</span> <span class="n">finite_mask</span>

    <span class="c1"># Conserve only the valid values and save the input shape</span>
    <span class="n">original_shape</span> <span class="o">=</span> <span class="n">rho</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">rho</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>

    <span class="c1"># Compute the Zernike polynomial and its derivatives if needed</span>
    <span class="k">if</span> <span class="n">max_derivative_order</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Only the polynomial is computed</span>
        <span class="n">rho_derivative</span> <span class="o">=</span> <span class="n">theta_derivative</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">output_polynomials</span> <span class="o">=</span> <span class="n">core_polynomial</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">rho_derivative</span><span class="o">=</span><span class="n">rho_derivative</span><span class="p">,</span> <span class="n">theta_derivative</span><span class="o">=</span><span class="n">theta_derivative</span><span class="p">,</span> <span class="n">flag_radial</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">precompute</span><span class="o">=</span><span class="n">precompute</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">max_derivative_order</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">skip_0_derivative</span><span class="p">:</span>
        <span class="c1"># The first derivatives of the Zernike polynomial are also computed</span>
        <span class="n">rho_derivative</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">theta_derivative</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">output_polynomials</span> <span class="o">=</span> <span class="n">core_polynomial</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">m</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">rho_derivative</span><span class="o">=</span><span class="n">rho_derivative</span><span class="p">,</span> <span class="n">theta_derivative</span><span class="o">=</span><span class="n">theta_derivative</span><span class="p">,</span> <span class="n">flag_radial</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">precompute</span><span class="o">=</span><span class="n">precompute</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">max_derivative_order</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">skip_0_derivative</span><span class="p">:</span>
        <span class="c1"># The first derivatives of the Zernike polynomial are also computed</span>
        <span class="n">rho_derivative</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">theta_derivative</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">output_polynomials</span> <span class="o">=</span> <span class="n">core_polynomial</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">m</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">rho_derivative</span><span class="o">=</span><span class="n">rho_derivative</span><span class="p">,</span> <span class="n">theta_derivative</span><span class="o">=</span><span class="n">theta_derivative</span><span class="p">,</span> <span class="n">flag_radial</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">precompute</span><span class="o">=</span><span class="n">precompute</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">max_derivative_order</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">skip_0_derivative</span><span class="p">:</span>
        <span class="c1"># The second derivatives of the Zernike polynomial are also computed</span>
        <span class="n">rho_derivative</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">theta_derivative</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">output_polynomials</span> <span class="o">=</span> <span class="n">core_polynomial</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">6</span><span class="p">,</span> <span class="n">m</span> <span class="o">*</span> <span class="mi">6</span><span class="p">,</span> <span class="n">rho_derivative</span><span class="o">=</span><span class="n">rho_derivative</span><span class="p">,</span> <span class="n">theta_derivative</span><span class="o">=</span><span class="n">theta_derivative</span><span class="p">,</span> <span class="n">flag_radial</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">precompute</span><span class="o">=</span><span class="n">precompute</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">max_derivative_order</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">skip_0_derivative</span><span class="p">:</span>
        <span class="c1"># The second derivatives of the Zernike polynomial are also computed</span>
        <span class="n">rho_derivative</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">theta_derivative</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">output_polynomials</span> <span class="o">=</span> <span class="n">core_polynomial</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="n">m</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="n">rho_derivative</span><span class="o">=</span><span class="n">rho_derivative</span><span class="p">,</span> <span class="n">theta_derivative</span><span class="o">=</span><span class="n">theta_derivative</span><span class="p">,</span> <span class="n">flag_radial</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">precompute</span><span class="o">=</span><span class="n">precompute</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The function supports only the derivatives (0, 0), (1, 0), (0, 1), (2, 0), (0, 2), and (1, 1). For more complex derivatives, use the standard Zernike polynomial function with polar coordinates.&quot;</span><span class="p">)</span>

    <span class="c1"># Compose the final output depending on the derivative orders</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)):</span>
        <span class="c1"># Case (0, 0) : Only extract the polynomial</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">x_derivative</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">y_derivative</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_polynomials</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>

        <span class="c1"># Case (1, 0) : Extract the first derivative with respect to x</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">x_derivative</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">y_derivative</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">drho_dx</span> <span class="o">=</span> <span class="n">list_rho_eq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dtheta_dx</span> <span class="o">=</span> <span class="n">list_theta_eq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dZ_drho</span> <span class="o">=</span> <span class="n">output_polynomials</span><span class="p">[(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">shift_0_derivative</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span><span class="p">]</span>
            <span class="n">dZ_dtheta</span> <span class="o">=</span> <span class="n">output_polynomials</span><span class="p">[(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">shift_0_derivative</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span><span class="p">]</span>
            <span class="n">dZ_dx</span> <span class="o">=</span> <span class="n">dZ_drho</span> <span class="o">*</span> <span class="n">drho_dx</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">dZ_dtheta</span> <span class="o">*</span> <span class="n">dtheta_dx</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dZ_dx</span><span class="p">)</span>

        <span class="c1"># Case (0, 1) : Extract the first derivative with respect to y</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">x_derivative</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">y_derivative</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">drho_dy</span> <span class="o">=</span> <span class="n">list_rho_eq</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">dtheta_dy</span> <span class="o">=</span> <span class="n">list_theta_eq</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">dZ_drho</span> <span class="o">=</span> <span class="n">output_polynomials</span><span class="p">[(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">shift_0_derivative</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span><span class="p">]</span>
            <span class="n">dZ_dtheta</span> <span class="o">=</span> <span class="n">output_polynomials</span><span class="p">[(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">shift_0_derivative</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span><span class="p">]</span>
            <span class="n">dZ_dy</span> <span class="o">=</span> <span class="n">dZ_drho</span> <span class="o">*</span> <span class="n">drho_dy</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">dZ_dtheta</span> <span class="o">*</span> <span class="n">dtheta_dy</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dZ_dy</span><span class="p">)</span>

        <span class="c1"># Case (2, 0) : Extract the second derivative with respect to x</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">x_derivative</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">y_derivative</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">drho_dx</span> <span class="o">=</span> <span class="n">list_rho_eq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dtheta_dx</span> <span class="o">=</span> <span class="n">list_theta_eq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">d2rho_dx2</span> <span class="o">=</span> <span class="n">list_rho_eq</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">d2theta_dx2</span> <span class="o">=</span> <span class="n">list_theta_eq</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">dZ_drho</span> <span class="o">=</span> <span class="n">output_polynomials</span><span class="p">[(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">shift_0_derivative</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span><span class="p">]</span>
            <span class="n">dZ_dtheta</span> <span class="o">=</span> <span class="n">output_polynomials</span><span class="p">[(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">shift_0_derivative</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span><span class="p">]</span>
            <span class="n">d2Z_drho2</span> <span class="o">=</span> <span class="n">output_polynomials</span><span class="p">[(</span><span class="mi">3</span> <span class="o">-</span> <span class="n">shift_0_derivative</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span><span class="p">]</span>
            <span class="n">d2Z_dtheta2</span> <span class="o">=</span> <span class="n">output_polynomials</span><span class="p">[(</span><span class="mi">4</span> <span class="o">-</span> <span class="n">shift_0_derivative</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span><span class="p">]</span>
            <span class="n">d2Z_drhodtheta</span> <span class="o">=</span> <span class="n">output_polynomials</span><span class="p">[(</span><span class="mi">5</span> <span class="o">-</span> <span class="n">shift_0_derivative</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span><span class="p">]</span>
            <span class="n">d2Z_dx2</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2Z_drho2</span> <span class="o">*</span> <span class="n">drho_dx</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">d2Z_drhodtheta</span> <span class="o">*</span> <span class="n">dtheta_dx</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">])</span> <span class="o">*</span> <span class="n">drho_dx</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">+</span> \
                      <span class="n">dZ_drho</span> <span class="o">*</span> <span class="n">d2rho_dx2</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">+</span> \
                      <span class="p">(</span><span class="n">d2Z_dtheta2</span> <span class="o">*</span> <span class="n">dtheta_dx</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">d2Z_drhodtheta</span> <span class="o">*</span> <span class="n">drho_dx</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">])</span> <span class="o">*</span> <span class="n">dtheta_dx</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">+</span> \
                      <span class="n">dZ_dtheta</span> <span class="o">*</span> <span class="n">d2theta_dx2</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d2Z_dx2</span><span class="p">)</span>

        <span class="c1"># Case (0, 2) : Extract the second derivative with respect to y</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">x_derivative</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">y_derivative</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">drho_dy</span> <span class="o">=</span> <span class="n">list_rho_eq</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">dtheta_dy</span> <span class="o">=</span> <span class="n">list_theta_eq</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">d2rho_dy2</span> <span class="o">=</span> <span class="n">list_rho_eq</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">d2theta_dy2</span> <span class="o">=</span> <span class="n">list_theta_eq</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">dZ_drho</span> <span class="o">=</span> <span class="n">output_polynomials</span><span class="p">[(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">shift_0_derivative</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span><span class="p">]</span>
            <span class="n">dZ_dtheta</span> <span class="o">=</span> <span class="n">output_polynomials</span><span class="p">[(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">shift_0_derivative</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span><span class="p">]</span>
            <span class="n">d2Z_drho2</span> <span class="o">=</span> <span class="n">output_polynomials</span><span class="p">[(</span><span class="mi">3</span> <span class="o">-</span> <span class="n">shift_0_derivative</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span><span class="p">]</span>
            <span class="n">d2Z_dtheta2</span> <span class="o">=</span> <span class="n">output_polynomials</span><span class="p">[(</span><span class="mi">4</span> <span class="o">-</span> <span class="n">shift_0_derivative</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span><span class="p">]</span>
            <span class="n">d2Z_drhodtheta</span> <span class="o">=</span> <span class="n">output_polynomials</span><span class="p">[(</span><span class="mi">5</span> <span class="o">-</span> <span class="n">shift_0_derivative</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span><span class="p">]</span>
            <span class="n">d2Z_dy2</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2Z_drho2</span> <span class="o">*</span> <span class="n">drho_dy</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">d2Z_drhodtheta</span> <span class="o">*</span> <span class="n">dtheta_dy</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">])</span> <span class="o">*</span> <span class="n">drho_dy</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">+</span> \
                      <span class="n">dZ_drho</span> <span class="o">*</span> <span class="n">d2rho_dy2</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">+</span> \
                      <span class="p">(</span><span class="n">d2Z_dtheta2</span> <span class="o">*</span> <span class="n">dtheta_dy</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">d2Z_drhodtheta</span> <span class="o">*</span> <span class="n">drho_dy</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">])</span> <span class="o">*</span> <span class="n">dtheta_dy</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">+</span> \
                      <span class="n">dZ_dtheta</span> <span class="o">*</span> <span class="n">d2theta_dy2</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d2Z_dy2</span><span class="p">)</span>

        <span class="c1"># Case (1, 1) : Extract the mixed second derivative</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">x_derivative</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">y_derivative</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">drho_dx</span> <span class="o">=</span> <span class="n">list_rho_eq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dtheta_dx</span> <span class="o">=</span> <span class="n">list_theta_eq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">drho_dy</span> <span class="o">=</span> <span class="n">list_rho_eq</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">dtheta_dy</span> <span class="o">=</span> <span class="n">list_theta_eq</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">d2rho_dxdy</span> <span class="o">=</span> <span class="n">list_rho_eq</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="n">d2theta_dxdy</span> <span class="o">=</span> <span class="n">list_theta_eq</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="n">dZ_drho</span> <span class="o">=</span> <span class="n">output_polynomials</span><span class="p">[(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">shift_0_derivative</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span><span class="p">]</span>
            <span class="n">dZ_dtheta</span> <span class="o">=</span> <span class="n">output_polynomials</span><span class="p">[(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">shift_0_derivative</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span><span class="p">]</span>
            <span class="n">d2Z_drho2</span> <span class="o">=</span> <span class="n">output_polynomials</span><span class="p">[(</span><span class="mi">3</span> <span class="o">-</span> <span class="n">shift_0_derivative</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span><span class="p">]</span>
            <span class="n">d2Z_dtheta2</span> <span class="o">=</span> <span class="n">output_polynomials</span><span class="p">[(</span><span class="mi">4</span> <span class="o">-</span> <span class="n">shift_0_derivative</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span><span class="p">]</span>
            <span class="n">d2Z_drhodtheta</span> <span class="o">=</span> <span class="n">output_polynomials</span><span class="p">[(</span><span class="mi">5</span> <span class="o">-</span> <span class="n">shift_0_derivative</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span><span class="p">]</span>
            <span class="n">d2Z_dxdy</span> <span class="o">=</span> <span class="p">(</span><span class="n">d2Z_drho2</span> <span class="o">*</span> <span class="n">drho_dx</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">d2Z_drhodtheta</span> <span class="o">*</span> <span class="n">dtheta_dx</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">])</span> <span class="o">*</span> <span class="n">drho_dy</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">+</span> \
                       <span class="n">dZ_drho</span> <span class="o">*</span> <span class="n">d2rho_dxdy</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">+</span> \
                       <span class="p">(</span><span class="n">d2Z_dtheta2</span> <span class="o">*</span> <span class="n">dtheta_dx</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">+</span> <span class="n">d2Z_drhodtheta</span> <span class="o">*</span> <span class="n">drho_dx</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">])</span> <span class="o">*</span> <span class="n">dtheta_dy</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">+</span> \
                       <span class="n">dZ_dtheta</span> <span class="o">*</span> <span class="n">d2theta_dxdy</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d2Z_dxdy</span><span class="p">)</span>

    <span class="c1"># Reinsert the values into the original shape and set the default value for invalid points</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)):</span>
        <span class="n">full_output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">original_shape</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">output</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">full_output</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">output</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_output</span>

    <span class="k">return</span> <span class="n">output</span></div>

</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2025-2025, Artezaru.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>